schema: '2.0'
stages:
  merge_data:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/data/merge_data.py data/raw/
      data/interim/data_test_labels.csv data/interim/data_train.csv
    deps:
    - path: data/raw/
      md5: 23f0d9f2eeb44cce1b6fe785bc00f705.dir
      size: 22906530
      nfiles: 17
    - path: src/data/merge_data.py
      md5: 4bdaea231e42f0a996bdf8f0cc819d4e
      size: 6225
    params:
      src/config.yml:
        merge_data:
          data_paths:
            wp1: ./wp1.csv
            wp2: ./wp2.csv
            wp3: ./wp3.csv
            wp4: ./wp4.csv
            wp5: ./wp5.csv
            wp6: ./wp6.csv
            train: ./train.csv
            test: ./test.csv
          data_types:
            hors: int16
            u: float16
            v: float16
            ws: float16
            wd: float16
            wp: float16
          first_train_date: '2009-07-02 13:00:00'
          last_test_date: '2012-06-25 00:00:00'
    outs:
    - path: data/interim/data_test_labels.csv
      md5: ef24b964f024baad818ec6fd7d3978cd
      size: 156246
    - path: data/interim/data_train.csv
      md5: 3fb9da2c50762cf6b0fb1acab070586f
      size: 32426305
  aggregate_weather:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/data/aggregate_weather.py data/interim/data_train.csv
      data/interim/data_agg_weather.csv
    deps:
    - path: data/interim/data_train.csv
      md5: 3fb9da2c50762cf6b0fb1acab070586f
      size: 32426305
    - path: src/data/aggregate_weather.py
      md5: 9988031f1f3780ca91970afdeb0add7f
      size: 4691
    - path: src/data/aggregate_weather_config.py
      md5: 220ecb13ca44fc48bf3222c25aa8a566
      size: 2983
    - path: src/data/process_weather.py
      md5: 5b70c5c67b5211222364d51c65b9ced7
      size: 12005
    outs:
    - path: data/interim/data_agg_weather.csv
      md5: ff72e7cebb5aac085bb4d7944fa40fcc
      size: 8339620
  clip_data:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/data/clip_outliers.py data/interim/data_agg_weather.csv
      data/interim/data_clipped.csv
    deps:
    - path: data/interim/data_agg_weather.csv
      md5: ff72e7cebb5aac085bb4d7944fa40fcc
      size: 8339620
    - path: src/data/clip_outliers.py
      md5: 3ab35a574187b84d322a506212a0cb9a
      size: 4457
    params:
      src/config.yml:
        clip_outliers:
          clip_strategy: quantile_clip
          quantile_clip:
            exclude:
            - date
            - hors
            - hour
            - wd
            - month
            - wp
            - windfarm
            lower: 0.05
            upper: 0.95
          iqr_clip:
            exclude:
            - date
            - hors
            - hour
            - wd
            - wp
            - windfarm
    outs:
    - path: data/interim/data_clipped.csv
      md5: 5893538f6ff9024461b67d57f31336c1
      size: 8423569
  create_features:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/features/create_features.py
      data/interim/data_clipped.csv data/interim/data_featured.csv
    deps:
    - path: data/interim/data_clipped.csv
      md5: 5893538f6ff9024461b67d57f31336c1
      size: 8423569
    - path: src/features/create_features.py
      md5: 28606524a00146c780e69af449c1db0b
      size: 10682
    - path: src/features/create_features_config.py
      md5: 275e020e66046b9f51be54d421c0fd43
      size: 4607
    - path: src/features/math_functions.py
      md5: 13a54faaf4b114a43405a2aa83b318b1
      size: 4914
    - path: src/features/process_features.py
      md5: d3492b0a8c6b9e7438dee2f77700b2ca
      size: 18186
    outs:
    - path: data/interim/data_featured.csv
      md5: f8e495204f9da858cd16000bb27d79d1
      size: 111699321
  split_train_predict:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/data/split_train_predict.py
      data/interim/data_featured.csv data/processed/data_train.csv data/processed/data_predict.csv
    deps:
    - path: data/interim/data_featured.csv
      md5: f8e495204f9da858cd16000bb27d79d1
      size: 111699321
    - path: src/data/split_train_predict.py
      md5: 220947110cce5d1b4fcd94b6fb4e3046
      size: 2150
    params:
      src/config.yml:
        common.date_col: date
        common.target: wp
        split_train_predict:
          train_rows:
            dates:
            - '2009-07-02 13:00:00'
            - '2012-06-25 00:00:00'
            is_na: false
          predict_rows:
            dates:
            - '2011-01-01 01:00:00'
            - '2012-06-25 00:00:00'
            is_na: true
    outs:
    - path: data/processed/data_predict.csv
      md5: 74db2929c76e5b065dbbb3ccca9de60c
      size: 31043200
    - path: data/processed/data_train.csv
      md5: dd29dec2092c6d93ccfec84534b92640
      size: 77883457
  explore_train_model:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/models/explore_train_model.py
      data/processed/data_train.csv models/metadata/ models/
    deps:
    - path: data/processed/data_train.csv
      md5: dd29dec2092c6d93ccfec84534b92640
      size: 77883457
    - path: src/models/explore_train_model.py
      md5: f1e08b62cc445ef37dca4502d7a57cf3
      size: 23883
    params:
      src/config.yml:
        common.date_col: date
        common.seed: 42
        common.target: wp
        explore_train_model:
          features:
            date_period:
            - '2009-07-02 13:00:00'
            - '2012-06-25 00:00:00'
            include: all
            exclude:
            - date
            - wd_cos_d2s1
            - wd_sin_d2s1
            - ws_d2s1
            - wd_sin_d2s3
            - wd_cos_d2s3
            - ws_d2s3
          set_plot_params:
            is_on: true
          linear_model:
            cat_cols:
            - windfarm
            model_params:
              regressor__feature_selector__threshold: 1.0*median
              regressor__feature_selector__estimator__min_samples_leaf: 30
              regressor__model__fit_intercept: true
              regressor__model__alpha: 30
          params_search:
            is_on: false
            n_jobs: -1
            grid_params:
              n_splits: 5
              scoring: neg_mean_absolute_error
              regressor__model__alpha:
              - vals
              - - 0.01
              regressor__feature_selector__threshold:
              - vals
              - - 0.2*median
            cv_params:
              n_splits: 5
              return_train_score: true
              scoring:
                MSE: neg_mean_squared_error
                MAE: neg_mean_absolute_error
            plot_param_search:
              scoring: test_MAE
              metrics_to_track:
                test:
                - MSE
                - MAE
                - MAE_median
                - MAE_std
                - MAE_eval
              x_axis: regressor__model__alpha
              hover_cols:
              - test_MAE
              figsize:
              - 20
              - 10
          plot_learning_curve:
            is_on: false
            n_jobs: -1
            scoring: neg_mean_absolute_error
            figsize:
            - 20
            - 10
            n_splits: 5
          mlflow_config:
            mlflow_description: Test GitHub CI
            mlflow_tags:
              model: Ridge
              selector: ExtraTreesRegressor
              windfarm: categorical
            experiment_name: selector-ridge_model
    outs:
    - path: models/lc_plot.csv
      md5: 68b329da9893e34099c7d8ad5cb9c940
      size: 2
    - path: models/lc_plot_.csv
      md5: 68b329da9893e34099c7d8ad5cb9c940
      size: 2
    - path: models/lm_model.pkl
      md5: a73d32464781fd2933b02fd169702bfe
      size: 35060005
    - path: models/metadata/
      md5: 0589a857fda8cd2051979c3f8964b0c0.dir
      size: 842
      nfiles: 2
    - path: models/metrics.json
      md5: 63e6c673aa99fbfec6e076283f594b67
      size: 48
  predict:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/models/predict.py data/processed/data_predict.csv
      models/lm_model.pkl models/prediction/predictions.csv
    deps:
    - path: data/processed/data_predict.csv
      md5: 74db2929c76e5b065dbbb3ccca9de60c
      size: 31043200
    - path: models/lm_model.pkl
      md5: a73d32464781fd2933b02fd169702bfe
      size: 35060005
    - path: src/models/predict.py
      md5: 69739b411b37b5cf2cff869ca33cede2
      size: 2297
    params:
      src/config.yml:
        common.date_col: date
        common.target: wp
        explore_train_model.features.exclude:
        - date
        - wd_cos_d2s1
        - wd_sin_d2s1
        - ws_d2s1
        - wd_sin_d2s3
        - wd_cos_d2s3
        - ws_d2s3
        explore_train_model.features.include: all
    outs:
    - path: models/prediction/predictions.csv
      md5: 851e930f3635cc6f0acfdccd6c1fa680
      size: 1818259
  plot_feature_importances:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/visualization/plot_feature_importance.py
      data/processed/data_train.csv reports/figures/importance/
    deps:
    - path: data/processed/data_train.csv
      md5: dd29dec2092c6d93ccfec84534b92640
      size: 77883457
    - path: src/visualization/plot_feature_importance.py
      md5: 90acce78ee5e9d53b561f75ff2efb1a9
      size: 7604
    params:
      src/config.yml:
        common.seed: 42
        common.target: wp
        plot_feature_importance:
          features:
            include: all
            exclude:
            - date
          windfarm_col: windfarm
          get_permutation_importance:
            is_on: true
            n_repeats: 10
            train_test_cfg:
              test_size: 0.25
              shuffle: true
            random_forest_cfg:
              min_samples_leaf: 10
          plot_power_prediciton:
            is_on: true
            whiskers_len: 10
          plot_params:
            set_plot_params: true
            figsize:
            - 30
            - 15
            fontsize:
    outs:
    - path: reports/figures/importance/pfi_perm_feature_importances.png
      md5: 54d0a34ffc0dac0bb43990a2c3a2a74e
      size: 120851
  plot_exploratory:
    cmd: set PYTHONPATH=%PYTHONPATH%;./ && python src/visualization/plot_exploratory.py
      data/processed/data_train.csv reports/figures/exploratory/
    deps:
    - path: data/processed/data_train.csv
      md5: dd29dec2092c6d93ccfec84534b92640
      size: 77883457
    - path: src/visualization/plot_exploratory.py
      md5: 353469e66564411f9e9c41f2195c9f7b
      size: 7923
    params:
      src/config.yml:
        common.target: wp
        plot_exploratory:
          features:
            include:
            - windfarm
            - hour
            - ws
            - wd_sin
            - wd_cos
            - side
            - ws-wd_cos
            - ws_frac
            - ws_log
            - ws_med24
            - ws_l3
            - ws_l12
            exclude: []
          set_plot_params:
            is_on: true
          plot_corr_matrix:
            is_on: true
            cat_col: windfarm
            figsize:
            - 30
            - 15
            fontsize: 14
          plot_boxplot:
            is_on: true
            is_standardized: true
          plot_pairplot:
            is_on: false
            hue_col: windfarm
            kind: reg
            diag_kind: kde
            alpha: 0.3
    outs:
    - path: reports/figures/exploratory/
      md5: 442c094d39bafea3313e7642ecf9cc5c.dir
      size: 915426
      nfiles: 4
